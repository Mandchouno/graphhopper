name: PIT Guard

on:
  push:
    branches: [ "**" ]

jobs:
  pit:
    runs-on: ubuntu-latest
    env:
      MODULE: core
      DELTA_TOL: "0.00"
      TARGET_CLASSES: "com.graphhopper.reader.dem.EdgeSampling,com.graphhopper.reader.dem.HeightTile"
      PIT_REGRESSION: "false"

    steps:
      - name: Checkout HEAD (current commit)
        uses: actions/checkout@v4
        with:
          path: head

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('head/**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-
      
      - name: Build core and dependencies (HEAD)
        working-directory: head
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" -am -DskipTests install

      - name: Run PIT on HEAD
        working-directory: head
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" \
            -DskipITs \
            -DtestPlugin=junit5 \
            -DtargetClasses="${TARGET_CLASSES}" \
            -Dthreads=4 -DtimeoutConst=12000 -DtimeoutFactor=3.0 \
            -DoutputFormats=XML,HTML \
            org.pitest:pitest-maven:mutationCoverage
          bash scripts/pit_score.sh > ../head_score.txt
          echo "HEAD_SCORE=$(cat ../head_score.txt)"

      - name: Upload HEAD PIT report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-HEAD
          path: head/${{ env.MODULE }}/target/pit-reports

      - name: Checkout repository for HEAD~1
        uses: actions/checkout@v4
        with:
          path: head_prev
          fetch-depth: 2

      - name: Move to previous commit (HEAD~1)
        working-directory: head_prev
        run: |
          git checkout HEAD~1

      - name: Build core + dependencies (HEAD~1)
        working-directory: head_prev
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" -am -DskipTests install

      - name: Run PIT on HEAD~1
        working-directory: head_prev
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" \
            -DskipITs \
            -DtestPlugin=junit5 \
            -DtargetClasses="${TARGET_CLASSES}" \
            -Dthreads=4 -DtimeoutConst=12000 -DtimeoutFactor=3.0 \
            -DoutputFormats=XML,HTML \
            org.pitest:pitest-maven:mutationCoverage

          bash scripts/pit_score.sh > ../head_prev_score.txt
          echo "HEAD_PREV_SCORE=$(cat ../head_prev_score.txt)"

      - name: Upload HEAD~1 PIT report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-HEAD~1
          path: head_prev/${{ env.MODULE }}/target/pit-reports

      - name: Compare HEAD vs HEAD~1 and detect regression
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          prev = float(open('head_prev_score.txt').read().strip())
          head = float(open('head_score.txt').read().strip())
          tol  = float(os.getenv('DELTA_TOL','0.0'))

          print(f"HEAD~1: {prev:.2f} | HEAD: {head:.2f} | Tol: {tol:.2f}")

          env_path = os.environ['GITHUB_ENV']
          if head + 1e-9 < prev - tol:
            print(f"Mutation score dropped: HEAD~1 {prev:.2f} -> HEAD {head:.2f}")
            with open(env_path, 'a') as f:
              f.write('PIT_REGRESSION=true\n')
          else:
            print("No regression detected.")
          PY

      - name: Fail job because mutation score dropped
        if: env.PIT_REGRESSION == 'true'
        run: |
          echo "Mutation score dropped â†’ failing build."
          exit 42
