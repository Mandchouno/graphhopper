name: PIT Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, master ]

jobs:
  pit:
    runs-on: ubuntu-latest
    env:
      MODULE: core
      DELTA_TOL: "0.05"
      TARGET_CLASSES: "com.graphhopper.reader.dem.EdgeSampling,com.graphhopper.reader.dem.HeightTile"
      PIT_REGRESSION: "false"

    steps:
      - name: Checkout HEAD (PR)
        uses: actions/checkout@v4
        with:
          path: head

      - name: Setup Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('head/**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-
      
      - name: Build core and dependencies (HEAD)
        working-directory: head
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" -am -DskipTests install

      - name: Run PIT on HEAD
        working-directory: head
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" \
            -DskipITs \
            -DtestPlugin=junit5 \
            -DtargetClasses="${TARGET_CLASSES}" \
            -Dthreads=4 -DtimeoutConst=12000 -DtimeoutFactor=3.0 \
            -DoutputFormats=XML,HTML \
            org.pitest:pitest-maven:mutationCoverage
          bash scripts/pit_score.sh > ../head_score.txt
          echo "HEAD_SCORE=$(cat ../head_score.txt)"

      - name: Upload HEAD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-report-head
          path: head/${{ env.MODULE }}/target/pit-reports

      - name: Checkout BASE
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Build core and dependencies (BASE)
        working-directory: base
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" -am -DskipTests install

      - name: Run PIT on BASE
        working-directory: base
        run: |
          set -euxo pipefail
          mvn -q -pl "$MODULE" \
            -DskipITs \
            -DtestPlugin=junit5 \
            -DtargetClasses="${TARGET_CLASSES}" \
            -Dthreads=4 -DtimeoutConst=12000 -DtimeoutFactor=3.0 \
            -DoutputFormats=XML,HTML \
            org.pitest:pitest-maven:mutationCoverage
          bash scripts/pit_score.sh > ../base_score.txt
          echo "BASE_SCORE=$(cat ../base_score.txt)"

      - name: Upload BASE report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-report-base
          path: base/${{ env.MODULE }}/target/pit-reports

      - name: Compare scores and mark regression
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          base = float(open('base_score.txt').read().strip())
          head = float(open('head_score.txt').read().strip())
          tol  = float(os.getenv('DELTA_TOL','0.0'))
          print(f"Base: {base:.2f} | Head: {head:.2f} | Tol: {tol:.2f}")
          env_path = os.environ['GITHUB_ENV']
          if head + 1e-9 < base - tol:
              print(f"Mutation score dropped: base {base:.2f} -> head {head:.2f} (tol {tol:.2f})")
              with open(env_path, 'a') as f:
                  f.write('PIT_REGRESSION=true\n')
          else:
              print(f"OK: head {head:.2f} vs base {base:.2f} (tol {tol:.2f})")
          PY

      - name: Rickroll because mutation score dropped
        if: env.PIT_REGRESSION == 'true'
        uses: TejasvOnly/random-rickroll@master
        with:
          probability: '100'

      - name: Fail job because mutation score dropped
        if: env.PIT_REGRESSION == 'true'
        run: |
          echo "Failing because mutation score dropped"
          exit 42

